parameters:
  pool: {}
  variables: {}
  strategy: {}

jobs:
- job: Windows_Build
  pool: ${{ parameters.pool }}
  strategy: ${{ parameters.strategy }}
  variables: 
    CommonMSBuildArgs: "/p:ConfigurationGroup=$(BuildConfiguration) /p:TargetArchitecture=$(TargetArchitecture) /p:PortableBuild=$(PortableBuild) $(AdditionalMSBuildArguments)"
    MsbuildSigningArguments: /p:CertificateId=400 /v:detailed /p:SignType=$(SignType)
    OfficialBuildId: '$(Build.BuildNumber)'
    SourcesDirectory: $(Build.SourcesDirectory)
  steps:
  - script: $(SourcesDirectory)\build.cmd
      -- $(CommonMSBuildArgs)
      /t:BuildTraversalBuildDependencies /flp:v=diag
    displayName: Build traversal build dependencies
    condition: succeeded()
  - script: build.cmd
      --src-builds 
      -- $(CommonMSBuildArgs)
      /p:BuildAppx=false
    displayName: Build binaries 
    condition: succeeded()
  - task: MSBuild@1
    displayName: Build nuget packaegs
    inputs: 
      solution: '$(SourcesDirectory)\src\pkg\dir.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '$(CommonMSBuildArgs) 
      /p:BuildFullPlatformManifest=$(BuildFullPlatformManifest)
      /flp:v=detailed;LogFile=$(SourcesDirectory)\packages.log'
    condition: succeeded()
  - task: MSBuild@1
    displayName: Build sharedframework layout
    inputs: 
      solution: '$(SourcesDirectory)\src\sharedframework\sharedframework.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '$(CommonMSBuildArgs) 
      /flp:v=detailed;LogFile=$(SourcesDirectory)\sharedframework.log'
    condition: succeeded()
  - task: MSBuild@1
    displayName: Create installers
    inputs: 
      solution: '$(SourcesDirectory)\src\pkg\packaging\dir.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '/t:BuildInstallers 
        $(CommonMSBuildArgs) 
        /flp:v=detailed;LogFile=$(SourcesDirectory)\packaging.log'
    condition: succeeded()
  # - task: MSBuild@1
  #   displayName: Sign MSI and cab files
  #   inputs: 
  #     solution: '$(SourcesDirectory)\signing\sign.proj'
  #     msbuildVersion: 15.0
  #     msbuildArchitecture: x64
  #     msbuildArguments: '/t:SignMsiAndCab
  #       $(CommonMSBuildArgs) 
  #       $(MsbuildSigningArguments)'
  #   condition: succeeded()
  - task: MSBuild@1
    displayName: Create bundles
    inputs: 
      solution: '$(SourcesDirectory)\src\pkg\packaging\dir.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '/t:BuildCombinedInstallers
        $(CommonMSBuildArgs) 
        /flp:v=detailed;LogFile=$(SourcesDirectory)\createbundles.log'
    condition: succeeded()
  - task: MSBuild@1
    displayName: Extract engine from bundle
    inputs: 
      solution: '$(SourcesDirectory)\src\pkg\packaging\dir.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '/t:ExtractEngineBundle 
        $(CommonMSBuildArgs) 
        /flp:v=detailed;LogFile=$(SourcesDirectory)\extractengine.log'
    condition: succeeded()
  # - task: MSBuild@1
  #   displayName: Sign Engine
  #   inputs: 
  #     solution: '$(SourcesDirectory)\signing\sign.proj'
  #     msbuildVersion: 15.0
  #     msbuildArchitecture: x64
  #     msbuildArguments: '/t:SignEngine 
  #       $(CommonMSBuildArgs) 
  #       /flp:v=detailed;LogFile=$(SourcesDirectory)\signengine.log'
  #   condition: succeeded()
  - task: MSBuild@1
    displayName: Reattach engine to bundle
    inputs: 
      solution: '$(SourcesDirectory)\src\pkg\packaging\dir.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '/t:ReattachEngineToBundle  
        $(CommonMSBuildArgs) 
        /flp:v=detailed;LogFile=$(SourcesDirectory)\reattachengine.log'
    condition: succeeded()
  # - task: MSBuild@1
  #   displayName: Sign Bundle
  #   inputs: 
  #     solution: '$(SourcesDirectory)\signing\sign.proj'
  #     msbuildVersion: 15.0
  #     msbuildArchitecture: x64
  #     msbuildArguments: '/t:SignBundle  
  #       $(CommonMSBuildArgs) 
  #       /flp:v=detailed;LogFile=$(SourcesDirectory)\signbundle.log'
  #   condition: succeeded()
  - task: MSBuild@1
    displayName: Publish
    inputs: 
      solution: '$(SourcesDirectory)\publish\publish.proj'
      msbuildVersion: 15.0
      msbuildArchitecture: x64
      msbuildArguments: '$(CommonMSBuildArgs) 
        /p:PublishType=$(PublishType)
        /p:AzureAccountName=$(AzureAccountName) 
        /p:ContainerName=$(ContainerName) 
        /p:AzureAccessToken=$(AzureAccessToken) 
        /p:PublishRidAgnosticPackages=$(PublishRidAgnosticPackages) 
        /p:BuildFullPlatformManifest=$(BuildFullPlatformManifest) 
        /p:ChecksumAzureAccountName=$(ChecksumAzureAccountName) 
        /p:ChecksumContainerName=$(ChecksumContainerName) 
        /p:ChecksumAzureAccessToken=$(ChecksumAzureAccessToken) 
        /flp:v=detailed;LogFile=$(SourcesDirectory)\publish.log'
    condition: and(succeeded(), eq(variables.BuildConfiguration, 'Release'))
  - task: CopyFiles@2
    displayName: Copy Files to $(Build.StagingDirectory)\BuildLogs
    inputs:
      SourceFolder: '$(SourcesDirectory)'
      Contents: |
        *.log
        *.binlog
      TargetFolder: '$(Build.StagingDirectory)\BuildLogs'
    continueOnError: true
    condition: succeededOrFailed()
  - task: PublishBuildArtifacts@1
    displayName: Publish Artifact BuildLogs
    inputs:
      PathtoPublish: '$(Build.StagingDirectory)\BuildLogs'
      ArtifactName: $(Agent.Os)_$(Agent.JobName)
    continueOnError: true
    condition: succeededOrFailed()